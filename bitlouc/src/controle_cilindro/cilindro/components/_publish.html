<template id="cilindro-publish">
  <div>
        <v-stepper v-model="progresso" vertical light>
          <v-stepper-step editable :complete="Number(progresso) > 1" step="1">
            <div>{{ value.loja.nick }}</div>
            <small>Loja</small>
          </v-stepper-step>
          <v-stepper-content step="1">
            <v-flex>
                <loja-selec v-model="value.loja"></loja-selec>
            </v-flex>
          </v-stepper-content>
          <v-stepper-step editable :complete="Number(progresso) > 2" step="2">
            <div>{{ value.local.name }}</div>
            <small>Local</small>
          </v-stepper-step>
          <v-stepper-content step="2">
              <v-flex>
                <local-selec v-model="value.local" :loja_id="value.loja.id"></local-selec>
              </v-flex>
          </v-stepper-content>
          <v-stepper-step editable :complete="Number(progresso) > 3" step="3">
            <small>Dados do Cilindro</small>
          </v-stepper-step>
          <v-stepper-content step="3">
            <v-container grid-list-md>
                <v-layout row wrap>
                  <v-flex>
                <cil-fabric-selec v-model="value.fabricante" ></cil-fabric-selec>
                </v-flex>
                <v-flex>
                  <v-text-field
                    type="text"
                    v-model="value.numero"
                    label="Numero Serie"
                    :error-messages="errors.collect('value.numero')"
                    v-validate="'required'"
                    data-vv-name="value.numero"
                    item-text="name"
                    required
                  ></v-text-field>
                </v-flex>
                <v-flex>
                  <cil-capac-selec v-model="value.capacidade" ></cil-capac-selec>
                </v-flex>
                </v-layout>
              
              
              <v-layout row wrap>
                <v-flex  xs11 sm5>
                  <date-add :value.sync="value.dt_fabric" label="Data Fabricação" ></date-add>
                </v-flex>
                <v-flex>
                    <v-text-field
                      type="number"
                      v-model="value.tara_inicial"
                      label="Tara Inicial"
                      :error-messages="errors.collect('value.tara_inicial')"
                      v-validate="'required'"
                      data-vv-name="value.tara_inicial"
                      item-text="name"
                      required
                    ></v-text-field>
                  </v-flex>
                
              </v-layout>
              <v-layout row wrap>
                <v-flex  xs11 sm5>
                    <date-add :value.sync="value.dt_validade" label="Data Validade" ></date-add>
                  </v-flex>
                <v-flex>
                  <v-text-field
                    type="text"
                    v-model="value.tara_atual"
                    label="Tara Atual"
                    :error-messages="errors.collect('value.tara_atual')"
                    v-validate="'required'"
                    data-vv-name="value.tara_atual"
                    item-text="name"
                    required
                  ></v-text-field>
                </v-flex>
              </v-layout>
              
            </v-container>
          </v-stepper-content>
        </v-stepper>
  </div>
</template>


<script>
Vue.component('cilindro-publish', {
  name: 'cilindro-publish',
  template: '#cilindro-publish',
  $_veeValidate: {
    validator: 'new'
  },
  props: {
    value: {},
    data: {},
  },
  data() {
    return {
      errorMessage: [],
      successMessage: [], 
      progresso: '1',
      
      item: this.value,
      loja:{},
      local : {},
      numero: '',
      fabricante: '',
      capacidade: null,
      dt_fabric: '',
      dt_validade: '',
      tara_inicial: '',
      tara_atual: '',
      condenado:    '0',
      status:       '0',
      ativo:        '0',
    };
  },
  watch: {
    'item': function (newQuestion, oldQuestion) {
      //this.retorno()
    },
  },
  mounted () {
    this.$validator.localize('pt_BR', this.dictionary)
  },
  computed: {
    user()  {
      return this.$store.getters.user;
    },
    temMessage () {
      if(this.errorMessage.length > 0) return true
      if(this.successMessage.length > 0) return true
      return false
    },
  },
  created: function() {
    this.dataT();
  },
  methods: {
    saveItem: function(){
      this.errorMessage = []
      this.$validator.validateAll().then((result) => {
        if (result && this.checkForm()) {
          var postData = {
            loja:         this.loja,
            local_id :    this.local.id,
            numero:       this.numero.toUpperCase(),
            fabricante:   this.fabricante,
            capacidade:   this.capacidade,
            dt_fabric:    this.dt_fabric+'-01',
            dt_validade:  this.dt_validade+'-01',
            tara_inicial: this.tara_inicial,
            tara_atual:   this.tara_atual,
            condenado:    '0',
            status:       '0',
            ativo:        '0',
            id:           ''
          };
          console.log(postData);
          this.$store.dispatch('publishCilindro', postData ).then(() => {
            this.atualizar();
          })
          .catch(function(error) {
            console.log(error);
          });
        }
      });
    },
    close () {
      this.dialog = false;
      this.$emit('close');
    },
    atualizar: function(){
      setTimeout(() => {
        this.dialog = false;
        this.$emit('atualizar');
      }, 2000);
    },
    remove (item) {
        //const index = this.loja.indexOf(item)
        //if (index >= 0) this.loja.splice(index, 1)
        this.loja = null
    },
    checkForm:function() {
      this.errorMessage = [];
      if( !this.loja ) this.errorMessage.push("Loja necessário.");
      if(!this.errorMessage.length) return true;
      //e.preventDefault();
    },
    retorno () {
      this.$emit('update:value', this.item)
    },
    dataT() {
      var datetime = new Date().toLocaleString();
      var res = datetime.split(" ");
      var date = res[0].split("/");
      var time = res[1].slice(0, -3);
      var dtTime = date[2] + "-" + date[1] + "-" + date[0];
      this.dataProg = dtTime;
    },
  },
});
</script>